<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking - {{ examen.titulo }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/inicio_instructor.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ranking.css') }}">
</head>
<body>
    <header>
        <div class="header">
            <div class="logo-cidt">
                <a class="a_logo-sena" target="_blank" href="https://zajuna.sena.edu.co/">
                    <img src="{{ url_for('static', filename='img/logo_sena.png') }}" alt="logo del SENA" />
                </a>
                <h5 class="logo-cidt-text">
                    Centro Industrial <br />
                    y del Desarrollo Tecnologico <br />
                    <p class="p-logo-cidt">Regional Santander</p>
                </h5>
            </div>
            <div class="session-container">
                 <a href="{{ url_for('inicio_instructor') }}" class="logout-button">← Volver</a>
            </div>
        </div>
        <div class="nav"></div>
    </header>

    <main class="contenido">
        <!-- Panel Izquierdo -->
        <div class="info-panel">
            <div class="info-box">
                <h2>{{ examen.titulo }}</h2>
                <p>
                    Tipo: {{ examen.tipo.capitalize() }} | Fase: {{ examen.fase }} | Año: {{ examen.anio }}
                </p>
                <hr>
                <p>Total de Aprendices: <span>{{ ranking|length }}</span></p>
            </div>

            {% if ranking and examen.fase == 1 %}
            <div class="info-box actions-box">
                 <div id="selection-counter" class="selection-counter">Seleccionados: 0</div>
                 <button id="btn-open-modal" class="btn btn-asignar-fase2">Asignar a Fase 2</button>
            </div>
            {% endif %}
        </div>

        <!-- Panel Derecho -->
        <div class="table-panel">
            <div class="ranking-table-container">
                {% if ranking %}
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">Posición</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Identificación</th>
                            <th style="text-align: center;">Ficha</th>
                            <th style="text-align: center;">Puntaje</th>
                            <th style="text-align: center;">Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        {% for aprendiz in ranking %}
                        <tr id="aprendiz-{{ aprendiz.identificacion }}" class="{{ 'top-30' if loop.index <= 30 else '' }}">
                            <td class="position">{{ loop.index }}</td>
                            <td>{{ aprendiz.nombre }}</td>
                            <td>{{ aprendiz.apellido }}</td>
                            <td>{{ aprendiz.identificacion }}</td>
                            <td style="text-align: center;">{{ aprendiz.id_ficha }}</td>
                            <td class="score">{{ aprendiz.calificacion }}</td>
                            <td style="text-align: center;">
                                <input type="checkbox" data-identificacion="{{ aprendiz.identificacion }}" {{ 'checked' if loop.index <= 30 }}>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="text-align: center; padding: 20px;">No hay resultados para mostrar en el ranking.</p>
                {% endif %}
            </div>
            <div id="pagination-container" class="pagination-container"></div>
        </div>
    </main>

    <!-- Modal para Asignar Fechas -->
    <div id="modal-asignar-fechas" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2>Asignar Fechas para Fase 2</h2>
                <span class="cerrar-modal">&times;</span>
            </div>
            <p>Por favor, define el rango de fechas para el examen de Fase 2.</p>
            <div class="form-grupo">
                <label for="fecha-inicio">Fecha de Inicio *</label>
                <input type="datetime-local" id="fecha-inicio" name="fecha-inicio" class="form-control" required />
            </div>
            <div class="form-grupo">
                <label for="fecha-fin">Fecha de Fin *</label>
                <input type="datetime-local" id="fecha-fin" name="fecha-fin" class="form-control" required />
            </div>
            <div class="modal-footer" style="text-align: right; margin-top: 20px;">
                <button id="btn-confirmar-asignacion" class="btn-guardar">Confirmar Asignación</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const allCheckboxes = Array.from(document.querySelectorAll('#ranking-body input[type="checkbox"]'));
            const counter = document.getElementById('selection-counter');
            
            function updateCounter() {
                // Se cuenta sobre todos los checkboxes, no solo los visibles
                const count = allCheckboxes.filter(cb => cb.checked).length;
                if (counter) {
                    counter.textContent = `Seleccionados: ${count}`;
                }
            }
            
            // Adjuntar evento a los checkboxes originales
            allCheckboxes.forEach(cb => cb.addEventListener('change', updateCounter));
            updateCounter();

            const tableBody = document.getElementById('ranking-body');
            const originalRows = Array.from(tableBody.querySelectorAll('tr'));
            const rowsPerPage = 30;
            const paginationContainer = document.getElementById('pagination-container');
            const totalPages = Math.ceil(originalRows.length / rowsPerPage);

            function setupPagination() {
                if (totalPages <= 1) return;
                let paginationHTML = `<a href="#" class="page-link" id="prev-page">&laquo; Anterior</a>`;
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<a href="#" class="page-link" data-page="${i}">${i}</a>`;
                }
                paginationHTML += `<a href="#" class="page-link" id="next-page">Siguiente &raquo;</a>`;
                paginationContainer.innerHTML = paginationHTML;

                paginationContainer.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (e.target.matches('.page-link')) {
                        const pageNumber = e.target.dataset.page;
                        if (pageNumber) goToPage(parseInt(pageNumber));
                        else if (e.target.id === 'prev-page') goToPage(currentPage - 1);
                        else if (e.target.id === 'next-page') goToPage(currentPage + 1);
                    }
                });
            }
            
            let currentPage = 1;
            function goToPage(pageNumber) {
                if (pageNumber < 1 || pageNumber > totalPages) return;
                currentPage = pageNumber;

                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;

                tableBody.innerHTML = '';
                originalRows.slice(startIndex, endIndex).forEach(row => tableBody.appendChild(row));

                document.querySelectorAll('.page-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page && parseInt(link.dataset.page) === currentPage) {
                        link.classList.add('active');
                    }
                });

                const prevPageLink = document.getElementById('prev-page');
                if(prevPageLink) prevPageLink.classList.toggle('disabled', currentPage === 1);

                const nextPageLink = document.getElementById('next-page');
                if(nextPageLink) nextPageLink.classList.toggle('disabled', currentPage === totalPages);
            }

            if(originalRows.length > 0) {
                setupPagination();
                goToPage(1);
            }

            const modal = document.getElementById('modal-asignar-fechas');
            const btnOpenModal = document.getElementById('btn-open-modal');
            const btnCerrarModal = modal.querySelector('.cerrar-modal');
            const btnConfirmar = document.getElementById('btn-confirmar-asignacion');

            if (btnOpenModal) {
                btnOpenModal.addEventListener('click', () => modal.style.display = 'block');
            }

            if(btnCerrarModal) {
              btnCerrarModal.addEventListener('click', () => modal.style.display = 'none');
            }
            
            window.addEventListener('click', (event) => {
                if (event.target == modal) modal.style.display = 'none';
            });

            if(btnConfirmar) {
              btnConfirmar.addEventListener('click', async () => {
                  const fecha_inicio = document.getElementById('fecha-inicio').value;
                  const fecha_fin = document.getElementById('fecha-fin').value;
                  
                  if (!fecha_inicio || !fecha_fin) { alert('Debes seleccionar una fecha de inicio y fin.'); return; }
                  if (new Date(fecha_fin) <= new Date(fecha_inicio)) { alert('La fecha de fin debe ser posterior a la de inicio.'); return; }
                  
                  const aprendices_ids = allCheckboxes.filter(cb => cb.checked).map(cb => cb.dataset.identificacion);

                  if (aprendices_ids.length === 0) { alert('No has seleccionado ningún aprendiz.'); return; }

                  const data = {
                      id_instrumento_fase1: {{ examen.id_instrumento }},
                      aprendices_ids: aprendices_ids,
                      fecha_inicio: fecha_inicio,
                      fecha_fin: fecha_fin
                  };

                  btnConfirmar.disabled = true;
                  btnConfirmar.textContent = 'Asignando...';

                  try {
                      const response = await fetch("{{ url_for('asignar_fase2') }}", {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify(data)
                      });
                      const result = await response.json();
                      if (!response.ok) throw new Error(result.error || 'Ocurrió un error en el servidor.');
                      
                      alert(result.message);
                      modal.style.display = 'none';
                  } catch (error) {
                      alert(`Error: ${error.message}`);
                  } finally {
                      btnConfirmar.disabled = false;
                      btnConfirmar.textContent = 'Confirmar Asignación';
                  }
              });
            }
        });
    </script>
</body>
</html>

